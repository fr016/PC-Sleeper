param (
    [string]$DomainFQDN = (Get-ADDomain).DNSRoot,
    [string]$LogPath = "$PSScriptRoot\ReplicationReport.log",
    [int]$ReplicationLatencyThreshold = 500
)

function Write-Log {
    param (
        [string]$Message
    )
    $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $logEntry = "$timestamp - $Message"
    Add-Content -Path $LogPath -Value $logEntry
}

function Get-ReplicationLatency {
    try {
        Write-Log "Starting replication latency test for all domain controllers in $DomainFQDN"

        $domainControllers = Get-ADDomainController -Filter *

        $results = foreach ($dc in $domainControllers) {
            $replicationInfo = Get-ADReplicationPartnerMetadata -Target $dc.HostName -Scope IncomingReplication
            foreach ($partner in $replicationInfo) {
                [pscustomobject]@{
                    DomainController  = $dc.HostName
                    ReplicationTime   = (New-TimeSpan -Start $partner.LastReplicationSuccess -End (Get-Date)).TotalSeconds
                }
            }
        }

        Write-Log "Replication latency test completed for all domain controllers."
        return $results
    }
    catch {
        Write-Log "Error during replication latency test: $_"
        throw $_
    }
    finally {
        Write-Log "End of Get-ReplicationLatency function."
    }
}

function Generate-ReplicationReport {
    param (
        [string]$DomainFQDN,
        [int]$ReplicationLatencyThreshold
    )

    try {
        Write-Log "Starting replication report generation for all domain controllers in $DomainFQDN"

        $replicationResults = Get-ReplicationLatency

        Write-Log "Replication latency test completed."

        $htmlContent = @"
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Replication Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #2F4F4F; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .alert { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Replication Report for $DomainFQDN</h1>
    <h2>Replication Test Results</h2>
    <table>
        <thead>
            <tr>
                <th>Domain Controller</th>
                <th>Replication Time (seconds)</th>
            </tr>
        </thead>
        <tbody>
"@

        foreach ($result in $replicationResults) {
            $alertClass = ""
            if ($result.ReplicationTime -gt $ReplicationLatencyThreshold) {
                $alertClass = "alert"
                Write-Log "Alert: High replication latency detected for $($result.DomainController) with a latency of $($result.ReplicationTime) seconds."
            }
            $htmlContent += "<tr class='$alertClass'><td>$($result.DomainController)</td><td>$($result.ReplicationTime)</td></tr>"
        }

        $htmlContent += @"
        </tbody>
    </table>
</body>
</html>
"@

        $reportPath = "$PSScriptRoot\Replication_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss').html"
        $htmlContent | Out-File -FilePath $reportPath -Encoding UTF8
        Write-Log "HTML report generated: $reportPath"
        Start-Process $reportPath
    }
    catch {
        Write-Log "Error during report generation: $_"
        throw $_
    }
    finally {
        Write-Log "End of Generate-ReplicationReport function."
    }
}

Generate-ReplicationReport -DomainFQDN $DomainFQDN -ReplicationLatencyThreshold $ReplicationLatencyThreshold
