function Measure-ADReplicationTime {
    param (
        [Parameter(Mandatory = $true)]
        [string]$DomainFQDN,

        [Parameter(Mandatory = $true)]
        [string]$TargetDC,

        [Parameter(Mandatory = $false)]
        [int]$MaxWaitTime = 600,  # Temps maximal d'attente en secondes (10 minutes par défaut)
        [Parameter(Mandatory = $false)]
        [int]$CheckInterval = 10  # Intervalle entre les vérifications en secondes
    )

    begin {
        try {
            # Importer le module Active Directory
            Import-Module ActiveDirectory -ErrorAction Stop

            # Récupérer le PDC du domaine cible
            $PDC = (Get-ADDomain -Server $DomainFQDN).PDCEmulator
            Write-Host "PDC détecté : $PDC"

            # Récupérer le conteneur "Users" par défaut du domaine cible
            $UsersContainer = (Get-ADDomain -Server $PDC).UsersContainer

            # Générer un nom unique pour l'utilisateur temporaire
            $guid = [guid]::NewGuid().ToString("N").Substring(0, 8)
            $tempUser = "ADCTest_$guid"
            $samAccountName = $tempUser.Substring(0, [Math]::Min(20, $tempUser.Length))

            # Créer l'utilisateur désactivé sur le PDC
            New-ADUser -Name $tempUser -SamAccountName $samAccountName -Path $UsersContainer -Enabled $false -Server $PDC
            Write-Host "Utilisateur temporaire '$tempUser' créé et désactivé sur $PDC à $(Get-Date)"
        } catch {
            Write-Error "Erreur lors de l'initialisation : $_"
            return
        }
    }

    process {
        try {
            $startTime = Get-Date
            $elapsedTime = 0

            do {
                Start-Sleep -Seconds $CheckInterval
                $elapsedTime += $CheckInterval

                try {
                    $user = Get-ADUser -Identity $samAccountName -Server $TargetDC -ErrorAction Stop
                } catch {
                    Write-Host "Utilisateur non trouvé sur $TargetDC après $elapsedTime secondes."
                }

                if ($user) {
                    $endTime = Get-Date
                    $replicationTime = $endTime - $startTime
                    Write-Host "Répliqué sur $TargetDC en $($replicationTime.TotalSeconds) secondes"
                    break
                }

            } while ($elapsedTime -lt $MaxWaitTime)

            if (-not $user) {
                Write-Error "La réplication vers $TargetDC n'a pas eu lieu dans le temps imparti de $MaxWaitTime secondes."
            }
        } catch {
            Write-Error "Erreur lors de la vérification de la réplication sur $TargetDC : $_"
        }
    }

    end {
        try {
            # Supprimer l'utilisateur temporaire sans confirmation
            Remove-ADUser -Identity $samAccountName -Server $PDC -Confirm:$false
            Write-Host "Utilisateur temporaire '$tempUser' supprimé de $PDC à $(Get-Date)"
        } catch {
            Write-Error "Erreur lors de la suppression de l'utilisateur temporaire : $_"
        }
    }
}

# Exemple d'utilisation
Measure-ADReplicationTime -DomainFQDN "example.com" -TargetDC "DC2.example.com"
