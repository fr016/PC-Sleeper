function Test-ADReplicationConvergence {
    <#
    .SYNOPSIS
    Mesure le temps de réplication d'un objet Active Directory depuis le PDC vers tous les contrôleurs de domaine.

    .DESCRIPTION
    Cette fonction crée un objet temporaire dans une unité d'organisation spécifiée sur le contrôleur de domaine principal (PDC) et mesure le temps nécessaire à chaque contrôleur de domaine pour répliquer cet objet.

    .PARAMETER OU
    Chemin de l'unité d'organisation où l'objet temporaire sera créé. Par exemple : "OU=Test,DC=example,DC=com".

    .EXAMPLE
    Test-ADReplicationConvergence -OU "OU=Test,DC=example,DC=com"
    #>
    param (
        [Parameter(Mandatory = $true)]
        [string]$OU
    )

    # Obtenir le PDC
    $PDC = (Get-ADDomainController -Filter {OperationsMasterRoles -contains "PDCEmulator"}).Hostname
    Write-Host "PDC détecté : $PDC"

    # Obtenir la liste de tous les contrôleurs de domaine
    $DCs = Get-ADDomainController -Filter * | Select-Object -ExpandProperty Hostname

    # Nom unique pour l'objet temporaire
    $timestamp = Get-Date -Format "yyyyMMddHHmmss"
    $tempUser = "TempUser_$timestamp"

    # Créer l'objet utilisateur sur le PDC
    New-ADUser -Name $tempUser -SamAccountName $tempUser -Path $OU -Server $PDC -AccountPassword (ConvertTo-SecureString "P@ssw0rd123" -AsPlainText -Force) -Enabled $true
    Write-Host "Utilisateur temporaire '$tempUser' créé sur $PDC à $(Get-Date)"

    # Mesurer le temps de réplication pour chaque DC
    foreach ($DC in $DCs) {
        $startTime = Get-Date
        do {
            Start-Sleep -Seconds 5
            $user = Get-ADUser -Identity $tempUser -Server $DC -ErrorAction SilentlyContinue
        } while (-not $user)
        $endTime = Get-Date
        $replicationTime = $endTime - $startTime
        Write-Host "Répliqué sur $DC en $($replicationTime.TotalSeconds) secondes"
    }

    # Supprimer l'objet temporaire
    Remove-ADUser -Identity $tempUser -Server $PDC
    Write-Host "Utilisateur temporaire '$tempUser' supprimé de $PDC"
}

# Exemple d'utilisation
Test-ADReplicationConvergence -OU "OU=Test,DC=example,DC=com"
