<#
.SYNOPSIS
Vérifie et relance les tâches planifiées dans un dossier spécifié sur un ordinateur distant.

.DESCRIPTION
Ce script vérifie les tâches planifiées dans un dossier donné sur un ordinateur distant et tente de les relancer si leur dernière exécution n'a pas été réussie. Il effectue jusqu'à trois tentatives de relance.

.PARAMETER CheminDossierTaches
Le chemin du dossier contenant les tâches planifiées à surveiller.

.PARAMETER NomOrdinateur
Le nom de l'ordinateur distant sur lequel vérifier et relancer les tâches planifiées.

.EXAMPLE
.\RelancerTaches.ps1 -CheminDossierTaches "C:\chemin\vers\DirMon" -NomOrdinateur "NomOrdinateur"
Ce commande vérifie et relance les tâches planifiées dans le dossier "C:\chemin\vers\DirMon" sur l'ordinateur distant "NomOrdinateur".

.NOTES
Auteur : OpenAI
Date : 2024-03-18
Version : 1.0
#>

function VerifierEtRelancerTache {
    param(
        [string]$cheminDossierTaches,
        [string]$nomTache,
        [string]$nomOrdinateur
    )

    $nombreTentatives = 3
    $tentative = 1
    $success = $false

    while ($tentative -le $nombreTentatives -and -not $success) {
        $lastRunTime = Invoke-Command -ComputerName $nomOrdinateur -ScriptBlock {
            param($cheminDossierTaches, $nomTache)
            Get-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache | Get-ScheduledTaskInfo | Select-Object -ExpandProperty LastRunTime
        } -ArgumentList $cheminDossierTaches, $nomTache

        if ($lastRunTime -eq $null) {
            Invoke-Command -ComputerName $nomOrdinateur -ScriptBlock {
                param($cheminDossierTaches, $nomTache)
                Start-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache
            } -ArgumentList $cheminDossierTaches, $nomTache

            Start-Sleep -Seconds 10

            $lastRunTime = Invoke-Command -ComputerName $nomOrdinateur -ScriptBlock {
                param($cheminDossierTaches, $nomTache)
                Get-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache | Get-ScheduledTaskInfo | Select-Object -ExpandProperty LastRunTime
            } -ArgumentList $cheminDossierTaches, $nomTache

            if ($lastRunTime -ne $null) {
                $success = $true
            }
        }
        else {
            $success = $true
        }

        $tentative++
    }

    return $success
}

function Main {
    param(
        [string]$cheminDossierTaches,
        [string]$nomOrdinateur
    )

    $nomsTaches = Invoke-Command -ComputerName $nomOrdinateur -ScriptBlock {
        param($cheminDossierTaches)
        Get-ScheduledTask -TaskPath $cheminDossierTaches | Select-Object -ExpandProperty TaskName
    } -ArgumentList $cheminDossierTaches

    foreach ($nomTache in $nomsTaches) {
        $resultatRelance = VerifierEtRelancerTache -cheminDossierTaches $cheminDossierTaches -nomTache $nomTache -nomOrdinateur $nomOrdinateur

        if ($resultatRelance) {
            Write-Host "La tâche $nomTache a été relancée avec succès sur $nomOrdinateur."
        }
        else {
            Write-Host "Impossible de relancer la tâche $nomTache après 3 tentatives sur $nomOrdinateur."
        }
    }
}

Main -cheminDossierTaches "C:\chemin\vers\DirMon" -nomOrdinateur "NomOrdinateur"

