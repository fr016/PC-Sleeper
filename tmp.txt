
<#
.SYNOPSIS
Vérifie et relance les tâches planifiées dans un dossier spécifié.

.DESCRIPTION
Ce script vérifie les tâches planifiées dans un dossier donné et tente de les relancer si leur dernière exécution n'a pas été réussie. Il effectue jusqu'à trois tentatives de relance.

.PARAMETER CheminDossierTaches
Le chemin du dossier contenant les tâches planifiées à surveiller.

.EXAMPLE
.\RelancerTaches.ps1 -CheminDossierTaches "C:\chemin\vers\DirMon"
Ce commande vérifie et relance les tâches planifiées dans le dossier "C:\chemin\vers\DirMon".

.NOTES
Auteur : Assistant de ChatGPT
Date : 2024-03-18
Version : 1.0
#>

function VerifierEtRelancerTache {
    param(
        [string]$cheminDossierTaches,
        [string]$nomTache
    )

    $nombreTentatives = 3
    $tentative = 1
    $success = $false

    while ($tentative -le $nombreTentatives -and -not $success) {
        $lastRunTime = Get-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache | Get-ScheduledTaskInfo | Select-Object -ExpandProperty LastRunTime

        if ($lastRunTime -eq $null) {
            Start-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache
            Start-Sleep -Seconds 10
            $lastRunTime = Get-ScheduledTask -TaskPath $cheminDossierTaches -TaskName $nomTache | Get-ScheduledTaskInfo | Select-Object -ExpandProperty LastRunTime
            if ($lastRunTime -ne $null) {
                $success = $true
            }
        }
        else {
            $success = $true
        }

        $tentative++
    }

    return $success
}

function Main {
    param(
        [string]$cheminDossierTaches
    )

    $nomsTaches = Get-ScheduledTask -TaskPath $cheminDossierTaches | Select-Object -ExpandProperty TaskName

    foreach ($nomTache in $nomsTaches) {
        $resultatRelance = VerifierEtRelancerTache -cheminDossierTaches $cheminDossierTaches -nomTache $nomTache

        if ($resultatRelance) {
            Write-Host "La tâche $nomTache a été relancée avec succès."
        }
        else {
            Write-Host "Impossible de relancer la tâche $nomTache après 3 tentatives."
        }
    }
}

Main -cheminDossierTaches "C:\chemin\vers\DirMon"
