function Test-ADReplicationConvergence {
    <#
    .SYNOPSIS
    Mesure le temps de replication d'un objet Active Directory depuis le PDC vers tous les controleurs de domaine.

    .DESCRIPTION
    Cette fonction cree un objet utilisateur temporaire desactive avec un nom aleatoire indiquant un test de convergence AD dans une unite d'organisation specifiee ou, par defaut, dans le conteneur "Users" du domaine cible. Elle mesure le temps necessaire a chaque controleur de domaine pour reperer cet objet, puis supprime l'utilisateur.

    .PARAMETER DomainFQDN
    Nom de domaine complet (FQDN) du domaine cible. Par exemple : "example.com".

    .PARAMETER OU
    Chemin de l'unite d'organisation ou l'objet temporaire sera cree. Par exemple : "OU=Test,DC=example,DC=com". Si non specifie, le conteneur "Users" du domaine cible sera utilise par defaut.

    .EXAMPLE
    Test-ADReplicationConvergence -DomainFQDN "example.com" -OU "OU=Test,DC=example,DC=com"
    #>
    param (
        [Parameter(Mandatory = $true)]
        [string]$DomainFQDN,

        [Parameter(Mandatory = $false)]
        [string]$OU
    )

    begin {
        try {
            # Importer le module Active Directory
            Import-Module ActiveDirectory -ErrorAction Stop

            # Obtenir le controleur de domaine principal (PDC) du domaine cible
            $PDC = (Get-ADDomainController -DomainName $DomainFQDN -Discover -Service "PrimaryDC").HostName
            Write-Host "PDC detecte : $PDC"

            # Si l'OU n'est pas specifiee, utiliser le conteneur "Users" par defaut du domaine cible
            if (-not $OU) {
                $OU = (Get-ADDomain -Server $PDC).UsersContainer
            }

            # Obtenir la liste de tous les controleurs de domaine du domaine cible
            $DCs = Get-ADDomainController -Filter * -Server $PDC | Select-Object -ExpandProperty HostName

            # Generer un nom unique pour l'utilisateur temporaire
            $guid = [guid]::NewGuid().ToString("N").Substring(0, 8)
            $tempUser = "ADCTest_$guid"
            $samAccountName = $tempUser.Substring(0, [Math]::Min(20, $tempUser.Length))

            # Creer l'utilisateur desactive sur le PDC
            New-ADUser -Name $tempUser -SamAccountName $samAccountName -Path $OU -Enabled $false -Server $PDC
            Write-Host "Utilisateur temporaire '$tempUser' cree et desactive sur $PDC a $(Get-Date)"
        } catch {
            Write-Error "Erreur lors de l'initialisation : $_"
            return
        }
    }

    process {
        foreach ($DC in $DCs) {
            try {
                $startTime = Get-Date
                do {
                    Start-Sleep -Seconds 5
                    $user = Get-ADUser -Identity $samAccountName -Server $DC -ErrorAction SilentlyContinue
                } while (-not $user)
                $endTime = Get-Date
                $replicationTime = $endTime - $startTime
                Write-Host "Replique sur $DC en $($replicationTime.TotalSeconds) secondes"
            } catch {
                Write-Error "Erreur lors de la verification sur $DC : $_"
            }
        }
    }

    end {
        try {
            # Supprimer l'utilisateur temporaire
            Remove-ADUser -Identity $samAccountName -Server $PDC
            Write-Host "Utilisateur temporaire '$tempUser' supprime de $PDC a $(Get-Date)"
        } catch {
            Write-Error "Erreur lors de la suppression de l'utilisateur temporaire : $_"
        }
    }
}

# Exemple d'utilisation avec le FQDN du domaine cible et l'OU par defaut
Test-ADReplicationConvergence -DomainFQDN "example.com"

# Exemple d'utilisation avec le FQDN du domaine cible et une OU specifique
Test-ADReplicationConvergence -DomainFQDN "example.com" -OU "OU=Test,DC=example,DC=com"
