#requires -Version 5.1
#requires -Modules ActiveDirectory, DnsClient

<#
.SYNOPSIS
Verifie que les enregistrements DNS d'un domaine correspondent aux adresses IP des controleurs de domaine dans un groupe AD et s'assure qu'un nombre minimum de controleurs de domaine est present.

.DESCRIPTION
Ce script recupere les enregistrements DNS d'un domaine specifie et les compare aux adresses IP des controleurs de domaine membres d'un groupe Active Directory donne. Il verifie egalement que le nombre de controleurs de domaine est superieur ou egal a un seuil defini. Les resultats de la verification sont affiches.

.PARAMETER DomainName
Nom du domaine a verifier.

.PARAMETER GroupName
Nom du groupe Active Directory contenant les controleurs de domaine.

.PARAMETER MinimumDcCount
Nombre minimum de controleurs de domaine requis dans le groupe (defaut: 10).

.EXAMPLE
.\Verifier-DnsDcCorrespondance.ps1 -DomainName "example.com" -GroupName "GroupeDC"

.NOTES
Auteur: Votre Nom
Date: 2025-03-06
#>
param (
    [Parameter(Mandatory = $true)]
    [string]$DomainName,

    [Parameter(Mandatory = $true)]
    [string]$GroupName,

    [int]$MinimumDcCount = 10
)

function Get-DomainControllerIPs {
    param (
        [Parameter(Mandatory = $true)]
        [string]$GroupName
    )
    try {
        $dcNames = Get-ADGroupMember -Identity $GroupName -server $DomainName -Recursive | Select-Object -ExpandProperty Name

        $dcIPs = foreach ($dc in $dcNames) {
            $hostname = $dc.TrimEnd('$')
            $ip = [System.Net.Dns]::GetHostAddresses($hostname) |
                Where-Object { $_.AddressFamily -eq 'InterNetwork' } |
                Select-Object -ExpandProperty IPAddressToString
            [PSCustomObject]@{ Name = $hostname; IP = $ip }
        }
        return $dcIPs
    }
    catch {
        Write-Host "Erreur lors de la recuperation des adresses IP des controleurs de domaine : $_"
        throw $_
    }
}

function Get-DnsARecords {
    param (
        [Parameter(Mandatory = $true)]
        [string]$DomainName
    )
    try {
        $dnsRecords = Resolve-DnsName -Name $DomainName -Type A
        $aRecords = $dnsRecords | Where-Object { $_.QueryType -eq 'A' } | Select-Object -ExpandProperty IPAddress
        return $aRecords
    }
    catch {
        Write-Host "Erreur lors de la recuperation des enregistrements DNS pour le domaine $DomainName : $_"
        throw $_
    }
}

function Compare-DnsAndDcIPs {
    param (
        [Parameter(Mandatory = $true)]
        [array]$DnsIPs,

        [Parameter(Mandatory = $true)]
        [array]$DcIPs
    )

    foreach ($ip in $DnsIPs) {
        if ($DcIPs -contains $ip) {
            try {
                $hostname = [System.Net.Dns]::GetHostEntry($ip).HostName
                Write-Host "L'adresse IP $ip correspond au controleur de domaine : $hostname."
            }
            catch {
                Write-Host "L'adresse IP $ip correspond a un controleur de domaine, mais le nom d'hote n'a pas pu etre resolu."
            }
        }
        else {
            try {
                $hostname = [System.Net.Dns]::GetHostEntry($ip).HostName
                Write-Host "ALERTE : L'adresse IP $ip (nom d'hote : $hostname) ne correspond a aucun controleur de domaine connu."
            }
            catch {
                Write-Host "ALERTE : L'adresse IP $ip ne correspond a aucun controleur de domaine connu et le nom d'hote n'a pas pu etre resolu."
            }
        }
    }
}

Write-Host "Debut de la verification des enregistrements DNS pour le domaine $DomainName."

$dcInfo = Get-DomainControllerIPs -GroupName $GroupName
$dcIPs = $dcInfo.IP

if ($dcIPs.Count -lt $MinimumDcCount) {
    Write-Host "ALERTE : Le nombre de controleurs de domaine est insuffisant. Nombre actuel : $($dcIPs.Count), Seuil minimum : $MinimumDcCount."
} else {
    Write-Host "Le nombre de controleurs de domaine est conforme ($($dcIPs.Count) detectes, minimum requis : $MinimumDcCount)."
}

$dnsIPs = Get-DnsARecords -DomainName $DomainName

Compare-DnsAndDcIPs -DnsIPs $dnsIPs -DcIPs $dcIPs

Write-Host "Fin de la verification des enregistrements DNS pour le domaine $DomainName."
