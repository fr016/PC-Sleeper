function Test-ADReplicationConvergence {
    <#
    .SYNOPSIS
    Measures the replication latency of an Active Directory object from the PDC to all domain controllers.

    .DESCRIPTION
    This function creates a temporary, disabled user object with a randomly generated name indicating it's for an AD convergence test in a specified Organizational Unit (OU) or, by default, in the "Users" container of the target domain. It measures the time taken for each domain controller to replicate this object and then deletes the user without confirmation.

    .PARAMETER DomainFQDN
    Fully Qualified Domain Name (FQDN) of the target domain. For example: "example.com".

    .PARAMETER OU
    Distinguished Name (DN) of the Organizational Unit where the temporary object will be created. For example: "OU=Test,DC=example,DC=com". If not specified, the default "Users" container of the target domain will be used.

    .PARAMETER MaxWaitTime
    Maximum time (in seconds) to wait for replication before timing out. Default is 600 seconds (10 minutes).

    .PARAMETER InitialInterval
    Initial wait time (in seconds) between replication checks. Default is 5 seconds.

    .PARAMETER MaxInterval
    Maximum wait time (in seconds) between replication checks. Default is 30 seconds.

    .EXAMPLE
    Test-ADReplicationConvergence -DomainFQDN "example.com" -OU "OU=Test,DC=example,DC=com" -MaxWaitTime 900 -InitialInterval 10 -MaxInterval 60
    #>
    param (
        [Parameter(Mandatory = $true)]
        [string]$DomainFQDN,

        [Parameter(Mandatory = $false)]
        [string]$OU,

        [Parameter(Mandatory = $false)]
        [int]$MaxWaitTime = 600,

        [Parameter(Mandatory = $false)]
        [int]$InitialInterval = 5,

        [Parameter(Mandatory = $false)]
        [int]$MaxInterval = 30
    )

    begin {
        try {
            # Import the Active Directory module
            Import-Module ActiveDirectory -ErrorAction Stop

            # Retrieve the PDC of the target domain
            $PDC = (Get-ADDomain -Server $DomainFQDN).PDCEmulator
            Write-Host "Detected PDC: $PDC"

            # If OU is not specified, use the default "Users" container of the target domain
            if (-not $OU) {
                $OU = (Get-ADDomain -Server $PDC).UsersContainer
            }

            # Retrieve the list of all domain controllers in the target domain
            $DCs = Get-ADDomainController -Filter * -Server $PDC | Select-Object -ExpandProperty HostName

            # Generate a unique name for the temporary user
            $guid = [guid]::NewGuid().ToString("N").Substring(0, 8)
            $tempUser = "ADCTest_$guid"
            $samAccountName = $tempUser.Substring(0, [Math]::Min(20, $tempUser.Length))

            # Create the disabled user on the PDC
            New-ADUser -Name $tempUser -SamAccountName $samAccountName -Path $OU -Enabled $false -Server $PDC
            Write-Host "Temporary user '$tempUser' created and disabled on $PDC at $(Get-Date)"
        } catch {
            Write-Error "Initialization error: $_"
            return
        }
    }

    process {
        foreach ($DC in $DCs) {
            try {
                $startTime = Get-Date
                $currentInterval = $InitialInterval
                do {
                    Start-Sleep -Seconds $currentInterval
                    $user = Get-ADUser -Identity $samAccountName -Server $DC -ErrorAction SilentlyContinue
                    if (-not $user) {
                        $currentInterval = [Math]::Min($currentInterval * 2, $MaxInterval)
                    }
                } while (-not $user -and ((Get-Date) - $startTime).TotalSeconds -lt $MaxWaitTime)

                if ($user) {
                    $endTime = Get-Date
                    $replicationTime = $endTime - $startTime
                    Write-Host "Replicated on $DC in $($replicationTime.TotalSeconds) seconds"
                } else {
                    Write-Error "Replication to $DC did not occur within the allotted time of $MaxWaitTime seconds"
                }
            } catch {
                Write-Error "Error checking replication on $DC: $_"
            }
        }
    }

    end {
        try {
            # Remove the temporary user without confirmation
            Remove-ADUser -Identity $samAccountName -Server $PDC -Confirm:$false
            Write-Host "Temporary user '$tempUser' removed from $PDC at $(Get-Date)"
        } catch {
            Write-Error "Error removing temporary user: $_"
        }
    }
}

# Example usage with the target domain's FQDN and default OU
Test-ADReplicationConvergence -DomainFQDN "example.com"

# Example usage with the target domain's FQDN, specific OU, and custom timing parameters
Test-ADReplicationConvergence -DomainFQDN "example.com" -OU "OU=Test,DC=example,DC=com" -MaxWaitTime 900 -InitialInterval 10 -MaxInterval 60
