param(
    [string]$CsvPath = ".\serveurs.csv",
    [string]$DownloadFolder = ".\ScriptsTéléchargés"
)

function Initialize-DownloadFolder {
    param([string]$Path)
    if (-not (Test-Path $Path)) {
        New-Item -ItemType Directory -Path $Path | Out-Null
    }
}

function Get-FQDN {
    param([string]$Hostname, [string]$Domain)
    return "$Hostname.$Domain"
}

function Download-RemoteScript {
    param(
        [string]$Fqdn,
        [string]$TaskName,
        [string]$RemotePath,
        [string]$LocalFolder
    )

    $fileName = "$Fqdn`_$TaskName.ps1"
    $localPath = Join-Path $LocalFolder $fileName

    $content = Invoke-Command -ComputerName $Fqdn -ScriptBlock {
        param($RemotePath)
        if (Test-Path $RemotePath) {
            Get-Content -Path $RemotePath -Raw
        } else {
            throw "Fichier introuvable : $RemotePath"
        }
    } -ArgumentList $RemotePath -ErrorAction Stop

    $content | Set-Content -Path $localPath -Force
    Write-Host "Téléchargé : $localPath"
}

function Process-TaskEntry {
    param(
        [string]$Hostname,
        [string]$Domain,
        [string]$TaskName,
        [string]$RemoteScriptPath,
        [string]$DownloadFolder
    )

    $fqdn = Get-FQDN -Hostname $Hostname -Domain $Domain
    Write-Host "`n[$fqdn] Tâche '$TaskName'"

    try {
        if ($RemoteScriptPath -like "*.ps1") {
            Download-RemoteScript -Fqdn $fqdn -TaskName $TaskName -RemotePath $RemoteScriptPath -LocalFolder $DownloadFolder
        } else {
            Write-Warning "Chemin non .ps1 pour '$TaskName' : $RemoteScriptPath"
        }
    } catch {
        Write-Warning "Erreur pour $fqdn - $TaskName : $_"
    }
}

function Main {
    param([string]$CsvPath, [string]$DownloadFolder)

    Initialize-DownloadFolder -Path $DownloadFolder

    $entries = Import-Csv -Path $CsvPath
    foreach ($entry in $entries) {
        Process-TaskEntry -Hostname $entry.hostname -Domain $entry.domain -TaskName $entry.name -RemoteScriptPath $entry.argument -DownloadFolder $DownloadFolder
    }
}

# Lancer le script
Main -CsvPath $CsvPath -DownloadFolder $DownloadFolder
