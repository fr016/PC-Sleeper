param (
    [switch]$Test
)

# Fonction pour télécharger les fichiers depuis S3
function DownloadFilesFromS3($bucket, $prefix, $destination) {
    Write-Host "Téléchargement des fichiers depuis S3..."
    
    # Obtenir la liste des clés (fichiers) dans le seau S3
    $s3Keys = Get-S3Objects -BucketName $bucket -Prefix $prefix
    
    # Télécharger chaque fichier dans le dossier de destination
    foreach ($key in $s3Keys) {
        $fileName = $key.Key -replace "$prefix/", ""
        $destinationPath = Join-Path $destination $fileName
        Get-S3Object -BucketName $bucket -Key $key.Key -DestinationPath $destinationPath
    }
    
    Write-Host "Téléchargement terminé."
}

# Fonction pour supprimer les fichiers du dossier de sauvegarde
function RemoveOldBackups($backupPath, $startDate) {
    Write-Host "Suppression des anciennes sauvegardes..."
    
    # Obtenir tous les fichiers dans le dossier de sauvegarde
    $backupFiles = Get-ChildItem -Path $backupPath
    
    # Parcourir tous les fichiers et supprimer ceux qui sont antérieurs à la date de début spécifiée
    foreach ($file in $backupFiles) {
        if ($file.LastWriteTime -lt $startDate) {
            Remove-Item -Path $file.FullName -Force
        }
    }
    
    Write-Host "Suppression des anciennes sauvegardes terminée."
}

# Scénario 1
if ($Test) {
    $bucket = "DomainTest"
    $backupPath = "C:\Backup\Domain FQDN"
    $prefixAD = "AD/DOMAINTEST1/daily/DCTeste1.DomainTest1FODN"
    $prefixBMR = "BMR/DOMAINTEST1/DCTest01.DomainTest1FODN"
    $startDateAD = Get-Date "2023-04-19 11:30:49"
    $startDateBMR = Get-Date "2023-04-12 11:30:49"
    
    # Télécharger les fichiers depuis S3
    DownloadFilesFromS3 -bucket $bucket -prefix $prefixAD -destination $backupPath
    
    # Supprimer les anciennes sauvegardes
    RemoveOldBackups -backupPath "$backupPath\AD\DC FODN" -startDate $startDateAD
    
    # Télécharger les fichiers depuis S3
    DownloadFilesFromS3 -bucket $bucket -prefix $prefixBMR -destination $backupPath
    
    # Supprimer les anciennes sauvegardes
    RemoveOldBackups -backupPath "$backupPath\BMR\DC FODN" -startDate $startDateBMR
    
    Write-Host "Scénario 1 terminé."
}

# Scénario 2
else {
    $bucket = "DomainTest"
    $backupPath = "C:\Backup\Domain FQDN"
    $prefixAD = "AD/DOMAINTEST1/daily/DCTest01.DomainTest1FODN"
    $prefixBMR = "BMR/DOMAINTEST1/DCTest01.DomainTest1FODN"
    $startDateAD = Get-Date "2023-04-19 11:30:49"
    $startDateBMR = Get-Date "2023-04-12 11:30:49"
    
    # Vérifier si le dossier de sauvegarde existe déjà
    if (-not (Test-Path -Path $backupPath)) {
        # Créer le dossier de sauvegarde
        New-Item -Path $backupPath -ItemType Directory | Out-Null
    }
    
    # Télécharger les fichiers depuis S3
    DownloadFilesFromS3 -bucket $bucket -prefix $prefixAD -destination $backupPath
    
    # Supprimer les anciennes sauvegardes
    RemoveOldBackups -backupPath "$backupPath\AD\DC FQDN" -startDate $startDateAD
    
    # Télécharger les fichiers depuis S3
    DownloadFilesFromS3 -bucket $bucket -prefix $prefixBMR -destination $backupPath
    
    # Supprimer les anciennes sauvegardes
    RemoveOldBackups -backupPath "$backupPath\BMR\DC FODN" -startDate $startDateBMR
    
    Write-Host "Scénario 2 terminé."
}
